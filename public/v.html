<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Viewer - Dark Tech Zone</title>
    <style>
        :root {
            --neon-green: #00ff00;
            --neon-green-dark: #00cc00;
            --bg-dark: #0a0a0a;
            --bg-darker: #000a00;
            --border-color: #003300;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --accent-red: #ff3333;
            --transition-fast: 0.2s ease;
            --border-radius-md: 8px;
            --spacing-sm: 10px;
            --spacing-md: 15px;
            --spacing-lg: 20px;
            --font-mono: 'Courier New', monospace;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: var(--bg-dark);
            color: var(--text-primary);
            font-family: var(--font-mono);
            min-height: 100vh;
            overflow: hidden;
        }
        
        .viewer-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--bg-dark);
        }
        
        .viewer-header {
            padding: var(--spacing-md) var(--spacing-lg);
            background: rgba(0, 20, 0, 0.8);
            border-bottom: 1px solid var(--neon-green);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .viewer-header h2 {
            margin: 0;
            color: var(--neon-green);
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .back-button {
            background: var(--border-color);
            color: var(--neon-green);
            border: 1px solid var(--neon-green);
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--font-mono);
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .back-button:hover {
            background: var(--neon-green);
            color: #000;
        }
        
        .viewer-frame {
            flex: 1;
            border: none;
            background: #fff;
        }
        
        .tool-loading {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--neon-green);
            font-family: var(--font-mono);
            background: var(--bg-dark);
        }
        
        .load-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--neon-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--accent-red);
            text-align: center;
            padding: 40px;
            font-size: 18px;
            background: var(--bg-dark);
        }
        
        .error-message i {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .error-message h3 {
            margin-bottom: 15px;
            color: var(--accent-red);
        }
        
        .error-actions {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }
        
        .back-btn, .home-btn {
            padding: 10px 20px;
            border: 1px solid var(--neon-green);
            background: rgba(0, 20, 0, 0.5);
            color: var(--neon-green);
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--font-mono);
            transition: all 0.3s;
        }
        
        .back-btn:hover, .home-btn:hover {
            background: var(--neon-green);
            color: #000;
        }
        
        .loading-subtext {
            color: var(--neon-green-dark);
            font-size: 0.9rem;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="viewer-container">
        <div class="viewer-header">
            <h2>
                <i class="fas fa-cube"></i>
                <span id="tool-title">Dark Tech Zone Tool</span>
            </h2>
            <button class="back-button" onclick="window.location.href='/'">
                <i class="fas fa-arrow-left"></i>
                Back to Toolkit
            </button>
        </div>
        
        <div id="viewer-content">
            <div class="tool-loading">
                <div class="load-spinner"></div>
                <p>Loading tool from Dark Tech Zone...</p>
                <p class="loading-subtext">Running in secure sandbox environment</p>
            </div>
        </div>
    </div>

    <!-- Font Awesome -->
    <script>
        const faLink = document.createElement('link');
        faLink.rel = 'stylesheet';
        faLink.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css';
        document.head.appendChild(faLink);
    </script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD369ImYdPQcgnystU9KQqs5Rhji07MLOw",
            authDomain: "dtz-toolkit.firebaseapp.com",
            databaseURL: "https://dtz-toolkit-default-rtdb.firebaseio.com",
            projectId: "dtz-toolkit",
            storageBucket: "dtz-toolkit.firebasestorage.app",
            messagingSenderId: "260322206338",
            appId: "1:260322206338:web:79049e8cc7a9fe54824a9b"
        };
        
        // Initialize Firebase
        let app, db, rtdb;
        
        function initializeFirebase() {
            try {
                if (typeof firebase === 'undefined') {
                    console.error('Firebase not loaded');
                    return false;
                }
                
                app = firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                rtdb = firebase.database();
                return true;
            } catch (error) {
                console.error('Firebase initialization error:', error);
                return false;
            }
        }
        
        // Tool Viewer Class
        class ToolViewer {
            constructor() {
                this.toolId = null;
                this.toolData = null;
                this.iframe = null;
                this.isLoading = false;
                
                // Get tool ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                this.toolId = urlParams.get('id');
                
                if (!this.toolId) {
                    this.showError('No tool ID specified');
                    return;
                }
                
                this.init();
            }
            
            async init() {
                // Initialize Firebase
                if (!initializeFirebase()) {
                    this.showError('Failed to initialize database');
                    return;
                }
                
                // Setup viewer
                this.setupViewer();
                
                // Load tool
                await this.loadTool();
            }
            
            setupViewer() {
                // Create sandboxed iframe
                this.iframe = document.createElement('iframe');
                this.iframe.className = 'viewer-frame';
                this.iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-modals allow-popups';
                this.iframe.allow = 'accelerometer; ambient-light-sensor; camera; encrypted-media; geolocation; gyroscope; microphone; midi; payment; usb; vr';
                this.iframe.setAttribute('referrerpolicy', 'no-referrer');
                
                // Get viewer content container
                const viewerContent = document.getElementById('viewer-content');
                if (viewerContent) {
                    viewerContent.innerHTML = '';
                    viewerContent.appendChild(this.iframe);
                }
            }
            
            async loadTool() {
                this.showLoading(true);
                
                try {
                    // Fetch tool data from Firestore
                    const toolDoc = await db.collection('tools').doc(this.toolId).get();
                    
                    if (!toolDoc.exists) {
                        throw new Error('Tool not found');
                    }
                    
                    this.toolData = toolDoc.data();
                    
                    // Check if tool is enabled
                    if (!this.toolData.enabled) {
                        throw new Error('This tool is currently disabled');
                    }
                    
                    // Check tool type
                    if (this.toolData.type !== 'hosted') {
                        throw new Error('This tool cannot be viewed in the viewer');
                    }
                    
                    // Check if hosted HTML exists
                    if (!this.toolData.hostedHtml) {
                        throw new Error('No HTML content available for this tool');
                    }
                    
                    // Update page title
                    document.title = `${this.toolData.name} - Dark Tech Zone`;
                    const toolTitle = document.getElementById('tool-title');
                    if (toolTitle) {
                        toolTitle.textContent = this.toolData.name;
                    }
                    
                    // Load tool into iframe
                    this.loadToolIntoIframe();
                    
                    // Track tool view
                    this.trackToolView();
                    
                } catch (error) {
                    console.error('Error loading tool:', error);
                    this.showError(error.message);
                } finally {
                    this.showLoading(false);
                }
            }
            
            loadToolIntoIframe() {
                if (!this.iframe || !this.toolData.hostedHtml) return;
                
                // Create a complete HTML document for the iframe
                const toolHtml = `
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>${this.escapeHtml(this.toolData.name)}</title>
                        <style>
                            body {
                                margin: 0;
                                padding: 20px;
                                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
                                background: #f5f5f5;
                                color: #333;
                            }
                            
                            .tool-container {
                                max-width: 1200px;
                                margin: 0 auto;
                            }
                            
                            .tool-header {
                                margin-bottom: 30px;
                                padding-bottom: 20px;
                                border-bottom: 2px solid #e0e0e0;
                            }
                            
                            .tool-title {
                                color: #2c3e50;
                                margin: 0 0 10px 0;
                            }
                            
                            .tool-description {
                                color: #7f8c8d;
                                margin: 0;
                            }
                            
                            .tool-watermark {
                                position: fixed;
                                bottom: 10px;
                                right: 10px;
                                color: rgba(0, 0, 0, 0.1);
                                font-size: 12px;
                                pointer-events: none;
                                user-select: none;
                            }
                            
                            /* Dark mode support */
                            @media (prefers-color-scheme: dark) {
                                body {
                                    background: #1a1a1a;
                                    color: #e0e0e0;
                                }
                                
                                .tool-header {
                                    border-bottom-color: #333;
                                }
                                
                                .tool-title {
                                    color: #fff;
                                }
                                
                                .tool-description {
                                    color: #aaa;
                                }
                            }
                            ${this.toolData.hostedCss || ''}
                        </style>
                    </head>
                    <body>
                        <div class="tool-container">
                            ${this.toolData.showHeader !== false ? `
                                <div class="tool-header">
                                    <h1 class="tool-title">${this.escapeHtml(this.toolData.name)}</h1>
                                    ${this.toolData.description ? `
                                        <p class="tool-description">${this.escapeHtml(this.toolData.description)}</p>
                                    ` : ''}
                                </div>
                            ` : ''}
                            
                            <!-- Tool content -->
                            ${this.toolData.hostedHtml}
                        </div>
                        
                        <div class="tool-watermark">
                            Powered by Dark Tech Zone
                        </div>
                        
                        <!-- Tool-specific scripts -->
                        ${this.toolData.hostedJs ? `<script>${this.toolData.hostedJs}<\/script>` : ''}
                        
                        <script>
                            // Tool isolation - prevent access to parent window
                            if (window.parent !== window) {
                                Object.defineProperty(window, 'parent', { get: () => null });
                                Object.defineProperty(window, 'top', { get: () => null });
                                Object.defineProperty(window, 'opener', { get: () => null });
                                
                                window.open = () => null;
                                window.alert = () => console.log('[Tool] Alert blocked by sandbox');
                                window.confirm = () => { console.log('[Tool] Confirm blocked by sandbox'); return false; };
                                window.prompt = () => { console.log('[Tool] Prompt blocked by sandbox'); return null; };
                                
                                window.addEventListener('beforeunload', (e) => {
                                    e.preventDefault();
                                    e.returnValue = '';
                                });
                            }
                            
                            document.addEventListener('DOMContentLoaded', () => {
                                console.log('Tool loaded in sandboxed environment');
                                
                                try {
                                    window.dispatchEvent(new Event('tool-loaded'));
                                } catch (e) {}
                            });
                        <\/script>
                    </body>
                    </html>
                `;
                
                // Write to iframe
                const iframeDoc = this.iframe.contentDocument || this.iframe.contentWindow.document;
                iframeDoc.open();
                iframeDoc.write(toolHtml);
                iframeDoc.close();
                
                // Add iframe event listeners
                this.setupIframeEvents();
            }
            
            setupIframeEvents() {
                if (!this.iframe) return;
                
                const iframeWindow = this.iframe.contentWindow;
                
                // Listen for tool loaded event
                iframeWindow.addEventListener('tool-loaded', () => {
                    console.log('Tool reported loaded successfully');
                    this.showLoading(false);
                });
                
                // Listen for errors in iframe
                iframeWindow.addEventListener('error', (e) => {
                    console.error('Tool error:', e);
                });
                
                // Monitor iframe load
                this.iframe.onload = () => {
                    console.log('Iframe loaded');
                    this.showLoading(false);
                };
                
                this.iframe.onerror = () => {
                    console.error('Iframe load error');
                    this.showError('Failed to load tool content');
                };
            }
            
            async trackToolView() {
                try {
                    const timestamp = Date.now();
                    const dateKey = new Date().toISOString().split('T')[0];
                    
                    const updates = {};
                    updates[`tool_views/${this.toolId}/total`] = firebase.database.ServerValue.increment(1);
                    updates[`tool_views/${this.toolId}/last_view`] = timestamp;
                    updates[`daily_views/${dateKey}/${this.toolId}`] = firebase.database.ServerValue.increment(1);
                    
                    await rtdb.ref().update(updates);
                    
                    // Store locally for analytics
                    localStorage.setItem(`last_tool_view_${this.toolId}`, timestamp.toString());
                    
                } catch (error) {
                    console.error('Error tracking tool view:', error);
                }
            }
            
            showLoading(show) {
                const viewerContent = document.getElementById('viewer-content');
                if (!viewerContent) return;
                
                if (show) {
                    this.iframe.style.display = 'none';
                    viewerContent.innerHTML = `
                        <div class="tool-loading">
                            <div class="load-spinner"></div>
                            <p>Loading "${this.toolData?.name || 'tool'}" from Dark Tech Zone...</p>
                            <p class="loading-subtext">Running in secure sandbox environment</p>
                        </div>
                    `;
                } else {
                    viewerContent.innerHTML = '';
                    viewerContent.appendChild(this.iframe);
                    this.iframe.style.display = 'block';
                }
            }
            
            showError(message) {
                const viewerContent = document.getElementById('viewer-content');
                if (viewerContent) {
                    viewerContent.innerHTML = `
                        <div class="error-message">
                            <div class="error-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <h3>Unable to Load Tool</h3>
                            <p>${this.escapeHtml(message)}</p>
                            <div class="error-actions">
                                <button onclick="window.history.back()" class="back-btn">
                                    <i class="fas fa-arrow-left"></i> Go Back
                                </button>
                                <button onclick="window.location.href='/'" class="home-btn">
                                    <i class="fas fa-home"></i> Return to Toolkit
                                </button>
                            </div>
                        </div>
                    `;
                }
            }
            
            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }
        
        // Initialize tool viewer when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const toolId = urlParams.get('id');
            
            if (!toolId) {
                document.getElementById('viewer-content').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <h3>Tool ID Missing</h3>
                        <p>No tool specified. Please return to the toolkit and select a tool.</p>
                        <div class="error-actions">
                            <button onclick="window.history.back()" class="back-btn">
                                <i class="fas fa-arrow-left"></i> Go Back
                            </button>
                            <button onclick="window.location.href='/'" class="home-btn">
                                <i class="fas fa-home"></i> Return to Toolkit
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            const toolViewer = new ToolViewer();
            window.toolViewer = toolViewer;
        });
    </script>
</body>
</html>